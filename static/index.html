<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPG Chat</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:"Segoe UI", Tahoma, sans-serif; }
body { background: linear-gradient(135deg, #1e293b, #0f172a); display:flex; justify-content:center; align-items:center; height:100vh; color:#fff; }

.container { width:95%; max-width:600px; }
#login, #register { background:#1e293b; padding:30px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.3); text-align:center; }
input { width:80%; padding:10px 12px; margin:10px 0; border:none; border-radius:25px; background:#0f172a; color:#fff; }
button { padding:12px 20px; margin-top:10px; border:none; border-radius:25px; background:#16a34a; color:white; font-weight:bold; cursor:pointer; transition:0.2s; }
button:hover { background:#15803d; }
a { color:#3b82f6; cursor:pointer; text-decoration:none; }
a:hover { text-decoration:underline; }

#chat { display:none; flex-direction:column; height:90vh; background:#1e293b; border-radius:15px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.3); }
#messages { flex:1; overflow-y:auto; padding:15px; font-size:15px; line-height:1.4; display:flex; flex-direction:column; }
.message { display:flex; margin:8px 0; animation:fadeIn 0.3s ease-in; }
.message.server { justify-content:flex-start; }
.message.server p { background:#3b82f6; border-radius:20px 20px 20px 5px; max-width:75%; padding:10px 14px; word-wrap:break-word; }
.message.user { justify-content:flex-end; }
.message.user p { background:#22c55e; border-radius:20px 20px 5px 20px; max-width:75%; padding:10px 14px; word-wrap:break-word; }

#input-area { display:flex; padding:10px; border-top:1px solid #334155; background:#0f172a; }
#msg { flex:1; padding:12px 15px; border:none; border-radius:25px; font-size:15px; outline:none; background:#1e293b; color:#fff; }

@keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
@media(max-width:768px){ #chat{height:100vh;border-radius:0;max-width:100%;} #messages{font-size:14px;} }
</style>
</head>
<body>

<div class="container">

  <!-- LOGIN -->
  <div id="login">
    <h2>Login</h2>
    <input id="login-user" placeholder="Usuário">
    <input id="login-pass" type="password" placeholder="Senha">
    <button id="login-btn">Entrar</button>
    <p>ou <a id="show-register">criar conta</a></p>
  </div>

  <!-- REGISTRO -->
  <div id="register" style="display:none">
    <h2>Registrar</h2>
    <input id="reg-user" placeholder="Usuário">
    <input id="reg-pass" type="password" placeholder="Senha">
    <button id="reg-btn">Registrar</button>
    <p>ou <a id="show-login">voltar ao login</a></p>
  </div>

  <!-- CHAT -->
  <div id="chat">
    <div id="messages"></div>
    <div id="input-area">
      <input id="msg" type="text" placeholder="Digite sua mensagem..." autocomplete="off"/>
      <button id="send">Enviar</button>
    </div>
  </div>

</div>

<script>
const loginDiv = document.getElementById("login");
const registerDiv = document.getElementById("register");
const chatDiv = document.getElementById("chat");

// alternar telas
document.getElementById("show-register").onclick = () => { loginDiv.style.display="none"; registerDiv.style.display="block"; }
document.getElementById("show-login").onclick = () => { loginDiv.style.display="block"; registerDiv.style.display="none"; }

// registrar
document.getElementById("reg-btn").onclick = async () => {
  const user = document.getElementById("reg-user").value;
  const pass = document.getElementById("reg-pass").value;
  const res = await fetch("/register", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({username:user,password:pass})});
  const data = await res.json();
  if(data.status==="ok") { alert("Registrado com sucesso!"); registerDiv.style.display="none"; loginDiv.style.display="block"; }
  else alert(data.msg);
}

// login
document.getElementById("login-btn").onclick = async () => {
  const user = document.getElementById("login-user").value;
  const pass = document.getElementById("login-pass").value;
  const res = await fetch("/login", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({username:user,password:pass})});
  const data = await res.json();
  if(data.status==="ok") { loginDiv.style.display="none"; initChat(user); }
  else alert(data.msg);
}

// iniciar chat
function initChat(username){
  chatDiv.style.display="flex";
  const socket = io(window.location.origin, { transports: ["websocket"] });

  const messages = document.getElementById("messages");
  const input = document.getElementById("msg");
  const sendBtn = document.getElementById("send");

  function addMessage(text, type="server"){
    const container = document.createElement("div");
    container.className = `message ${type}`;
    const p = document.createElement("p");
    p.textContent = text;
    container.appendChild(p);
    messages.appendChild(container);
    messages.scrollTop = messages.scrollHeight;
  }

  // Conexão
  socket.on("connect", () => {
    addMessage("✅ Conectado ao servidor!", "server");
    fetch("/history").then(r=>r.json()).then(msgs=>{
      msgs.forEach(m=>{
        const type = m.user === username ? "user" : "server";
        addMessage(`${m.user}: ${m.text}`, type);
      });
    });
  });

  // receber mensagem
  socket.on("message", (data)=>{
    if(!data.user||!data.text) return;
    if(data.user===username) return;
    addMessage(`${data.user}: ${data.text}`, "server");
  });

  sendBtn.onclick = () => {
    const msg = input.value.trim();
    if(!msg) return;
    socket.send({user: username, text: msg});
    addMessage(`${username}: ${msg}`, "user");
    input.value = "";
  }
  input.addEventListener("keypress", e => { if(e.key==="Enter") sendBtn.click(); });
}
</script>

</body>
</html>
